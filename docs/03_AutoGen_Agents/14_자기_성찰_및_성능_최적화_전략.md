# 14. 자기 성찰(Self-Reflection) 및 성능 최적화 전략

AI가 답변을 내놓은 뒤 스스로 문제점이나 대안을 한 번 더 검토하는 '두 번째 생각' 과정은 결과물의 품질을 비약적으로 높입니다. 하지만 모든 질문에 이 과정을 적용하면 속도가 저하될 수 있으므로, 효율적인 전략적 접근이 필요합니다.

## 1. '두 번째 생각'을 추가하는 3가지 방법

### (1) 프롬프트 단계: 자가 비판 루프 강제
에이전트의 시스템 프롬프트에 내부 사고 단계를 명시적으로 삽입합니다.
- **적용 방식**: `[초안] -> [비판] -> [수정]` 단계를 거쳐 최종 답변을 출력하도록 설정.
- **효과**: 에지 케이스, 성능 문제, 최신 사양(2026년형)과의 충돌을 스스로 사전에 걸러냅니다.

### (2) 워크플로우 단계: 검토 전문 에이전트(Reviewer) 배치
Dev1(Coder)이 작성한 결과물을 Dev2(Reviewer)가 전달받아 비판적으로 분석하고 수정 요청을 보내는 '생각의 핑퐁'을 자동화합니다.
- **장점**: 서로 다른 모델(예: 32B vs 14B) 간의 교차 검증을 통해 편향성을 줄이고 정제된 결론을 도출합니다.

### (3) 코드 단계: Python 루프를 이용한 Self-Correction
스크립트 레벨에서 답변 생성 후 다시 한 번 검증 프롬프트를 던져 최종안을 받아내는 방식입니다.
```python
def generate_high_quality_answer(prompt):
    # 1차 답변 생성
    initial = ollama.generate(model='qwen2.5:32b', prompt=prompt)
    
    # 2차 검토 및 수정 요청
    review_prompt = f"다음 답변의 오류나 대안을 검토하여 최종안을 작성하세요: '{initial['response']}'"
    final = ollama.generate(model='qwen2.5:32b', prompt=review_prompt)
    
    return final['response']
```

---

## 2. 가성비를 고려한 성능 최적화 필터링 (3단계)

모든 작업에 자기 성찰을 적용하면 시스템이 느려집니다. '선택과 집중'을 위한 전략입니다.

### [1단계] 난이도 기반 선택적 사고 (Selective Reflection)
- **난이도 하 (단순 구현)**: 즉시 답변 (0초 지연). 예: 변수명 추천, 단순 문법 질문.
- **난이도 중/상 (설계/복합 로직)**: '두 번째 생각' 루프 가동. 품질 최우선.
- **방법**: 중계자(Router)가 질문의 복잡도를 판단하여 성찰 루프 활성 여부를 결정합니다.

### [2단계] 실패 시 재시도 전략 (Fail-Fast Loop)
- **로직**: 일단 1차 답변을 내놓고, 중계자가 1초 만에 스캔하여 형식이 깨졌거나 참조 문서를 어겼을 때만 비판 루프를 돌립니다.
- **효과**: 대부분의 정상 답변은 빠르게 출력되고, 위험한 답변만 걸러내어 체감 속도를 보존합니다.

### [3단계] 스트리밍 및 병렬 검토 (Parallel Review)
- **방식**: 메인 답변이 스트리밍으로 출력되는 동안 백그라운드에서 리뷰어(14B)가 검토를 동시에 진행합니다.
- **UI 구현**: 사용자가 답변을 읽는 도중 하단에 `[Reviewer의 추가 제언]`이 실시간으로 추가되도록 구성 (Open WebUI 등 활용).

---

## 3. 에이전시 운영 팁: "생각의 깊이" 조절

상황에 따라 '검토 횟수(Iteration)'를 변수로 관리하여 유연하게 운영하십시오.

| 모드 | 검토 횟수 | 특징 |
| :--- | :---: | :--- |
| **Quick** | 0회 | 속도 최상, 단순 반복 작업용 |
| **Standard** | 1회 | 품질 균형, 일반적인 개발 작업용 |
| **Research** | 2회 이상 | 지능 최상, 아키텍처 설계 및 보안 검증용 |

**결론**: 중계자(Router)에게 "사용자 문서를 50% 이상 참조해야 하는 복잡한 건이면 리뷰어를 거치라"는 식의 구체적인 가이드를 주는 것이 가장 효율적입니다.
