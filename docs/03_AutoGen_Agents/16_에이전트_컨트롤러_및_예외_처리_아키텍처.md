# 16. 에이전트 컨트롤러 및 예외 처리 아키텍처

본 문서는 페르소나(역할 부여)를 배제하고 시스템의 효율성, 안정성, 확장성에 집중한 **'순수 기능적 관점'**의 에이전트 제어 및 에러 핸들링 전략을 다룹니다.

---

## 1. 핵심 설계 원칙 (Functional Design)

1.  **페르소나 배제**: 특정 캐릭터에 갇히지 않고 아키텍처의 본질(상태 관리, 예외 처리)에 집중합니다.
2.  **상태 기반 파이프라인**: 이슈의 생애 주기를 정의하고 각 단계별 성공/실패를 명확히 관리합니다.
3.  **작업의 원자성(Atomicity)**: 각 작업은 독립된 Git 브랜치에서 수행되며, 테스트 통과 시에만 메인 코드베이스에 반영됩니다.
4.  **환경 격리(Isolation)**: 로컬 환경 오염 방지를 위해 임시 브랜치 및 작업 디렉토리를 사용합니다.

---

## 2. 상태 기반 파이프라인 (State-Machine)

이슈 처리 과정을 4단계의 상태 머신으로 정의합니다.

| 단계 | 설명 | 비고 |
| :--- | :--- | :--- |
| **1. Queue** | 신규 이슈를 감지하고 상태 파일(JSON/Markdown)을 생성합니다. | 중복 실행 방지 |
| **2. Analysis** | 이슈 내용을 분석하여 처리 가능 여부 및 난이도를 분류합니다. | 비용 최적화 |
| **3. Execution** | 실제 코드 수정 및 테스트를 수행합니다. | 원자적 작업(Branch) |
| **4. Wait/Hold** | 쿼터 제한 등 외부 요인으로 중단 시 대기 상태로 전환합니다. | 자동 재시도 |

---

## 3. 에이전트 컨트롤러 (`AgentController`)

에이전트의 실행 여부를 결정하고 예외 상황에 대응하는 핵심 로직입니다.

```python
import time
import subprocess
import logging

class AgentController:
    def __init__(self):
        self.quota_status = "HEALTHY"  # HEALTHY, HOLD, PERMANENT_LIMIT
        self.retry_count = 0

    def check_system_readiness(self):
        """에이전트 실행 전 시스템 및 쿼터 상태 체크"""
        if self.quota_status == "PERMANENT_LIMIT":
            print("🚨 [Action] 계정 제한 상태입니다. 수동 개입이 필요합니다.")
            return False
        return True

    def handle_error(self, error_message, issue_number):
        """
        사용자 지침(2026-02-11) 반영 로직
        """
        # 1. 임시 쿼터 초과 (Claude Code 등)
        if "rate_limit" in error_message or "429" in error_message:
            self.quota_status = "HOLD"
            print(f"⚠️ [Hold] 임시 쿼터 제한 감지. 이슈 #{issue_number} 작업을 대기열에 유지합니다.")
            self.report_to_github(issue_number, "⏳ API 할당량 초과로 인해 작업이 일시 중단되었습니다. (자동 재시도 예정)")
            
        # 2. 영구적 만료 및 제한
        elif "expired" in error_message or "unauthorized" in error_message:
            self.quota_status = "PERMANENT_LIMIT"
            print(f"🚨 [Define Action] 영구적 제한 발생. 모든 작업을 중단하고 관리자에게 보고합니다.")
            self.report_to_github(issue_number, "❌ 에이전트 권한 만료로 작업이 중단되었습니다. 관리자의 확인이 필요합니다.")
            self.add_label(issue_number, "critical: agent-stopped")

    def report_to_github(self, issue_number, message):
        """GitHub에 상태 보고"""
        subprocess.run(["gh", "issue", "comment", str(issue_number), "-b", message])

    def add_label(self, issue_number, label):
        """이슈에 상태 라벨 추가"""
        subprocess.run(["gh", "issue", "edit", str(issue_number), "--add-label", label])

# 인스턴스 생성
controller = AgentController()
```

---

## 4. 예외 처리 정책 (Hold vs Action)

사용자 지침(2026-02-11)에 따라 두 가지 대응 시나리오를 가집니다.

### 4.1 임시 제한 (Hold)
*   **원인**: Claude Code 등 외부 API의 `429 Rate Limit` 발생.
*   **대응**: 
    *   작업을 Pending 큐로 이동하거나 `time.sleep()`을 통한 지수 백오프(Exponential Backoff) 실행.
    *   GitHub 이슈에 대기 상태 댓글 작성.
*   **이점**: 리소스 낭비를 방지하고 시스템 안정성 유지.

### 4.2 영구 제한 (Define Action)
*   **원인**: API 키 만료, 계정 차단, 권한 부족.
*   **대응**: 
    *   즉시 모든 프로세스를 중단하고 안전하게 종료.
    *   GitHub 이슈에 `critical: agent-stopped` 라벨을 부착하고 관리자에게 알림.
*   **이점**: 조기에 문제를 감지하여 무한 루프나 불필요한 비용 발생 차단.

---

## 5. 파일 시스템 기반 상태 관리 (Persistence)

맥미니와 맥북의 듀얼 맥 환경에서는 복잡한 DB(SQLite) 대신 파일 시스템 기반의 직관적인 상태 관리를 지향합니다.

*   **Git History**: 모든 수정 사항은 커밋 로그로 기록됩니다.
*   **Issue-based Directory**: `issues/issue-{ID}/` 디렉토리에 작업 결과물 보관.
    *   `status.json`: 현재 상태 (HOLD, COMPLETED, FAILED)
    *   `report.md`: 에이전트 작업 요약 및 LLM 사고 과정 기록.
*   **GitHub Integration**: 이슈의 댓글과 라벨을 실시간 상태 저장소로 활용합니다.

---

## 6. 향후 고도화 방향

1.  **데이터베이스 도입 고려**: 수천 건 이상의 이슈 처리 시 성능 최적화를 위해 SQLite 도입 검토.
2.  **태스크 분류기(Classifier)**: 이슈 내용을 사전에 분석하여 에이전트 처리 가능 여부를 90% 이상의 정확도로 판단하는 로직 추가.
3.  **지능형 재시도 전략**: 에러 유형에 따라 재시도 횟수와 대기 시간을 동적으로 조정.
