# 03. 개발자 협업 시스템 통합 코드

지능형 라우터와 연동하여 TDD 방식으로 작동하는 전체 AutoGen 에이전트 팀 구성 코드를 제공합니다.

## 1. 프로젝트 구조

```
my-autogen-project/
├── router.py          # Phase 02에서 정의한 LLM 라우터
├── dev_team.py        # 에이전트 팀 구성 및 메인 로직
├── config.py          # 에이전트 환경 설정
└── dev_repo/          # 에이전트가 코드를 작성하고 실행할 공간
```

## 2. 통합 에이전트 코드 (`dev_team.py`)

이 코드는 라우터(`http://localhost:8000`)를 통해 Qwen3 모델들을 호출합니다.

```python
import autogen
import os

# 1. LLM 라우터 설정 (모든 에이전트가 공유)
llm_config = {
    "config_list": [
        {
            "model": "qwen3-router",  # 라우터에서 모델을 결정하므로 이름은 임의 지정
            "base_url": "http://localhost:8000/route",
            "api_type": "openai",
            "api_key": "ollama-router"
        }
    ],
    "cache_seed": 42,
    "temperature": 0.5
}

# 2. 에이전트 정의
planner = autogen.AssistantAgent(
    name="Planner",
    system_message="""당신은 프로젝트 설계자입니다. 
    1. 요구사항을 분석하고 단계별 구현 계획을 세우세요.
    2. 특히 구현 전 반드시 통과해야 할 TDD 테스트 시나리오를 정의하세요.""",
    llm_config=llm_config
)

dev1 = autogen.AssistantAgent(
    name="Dev1_Senior",
    system_message="""당신은 시니어 개발자입니다. 
    1. Planner의 설계와 테스트 시나리오를 바탕으로 코드를 구현하세요.
    2. 테스트 코드를 먼저 작성하고, 이를 통과하는 기능 코드를 작성하세요.""",
    llm_config=llm_config
)

dev2 = autogen.AssistantAgent(
    name="Dev2_Reviewer",
    system_message="""당신은 코드 리뷰어입니다. 
    1. Dev1이 작성한 코드의 보안, 성능, 가독성을 검수하세요.
    2. 개선이 필요한 경우 구체적인 이유와 함께 수정을 요청하세요.""",
    llm_config=llm_config
)

tester = autogen.UserProxyAgent(
    name="Tester_QA",
    human_input_mode="NEVER",
    max_consecutive_auto_reply=3,
    is_termination_msg=lambda x: x.get("content", "").find("TERMINATE") >= 0,
    code_execution_config={
        "work_dir": "dev_repo",
        "use_docker": False # Mac 환경에서 로컬 실행 권장
    },
    system_message="""당신은 QA 엔지니어입니다. 
    1. Dev1이 작성한 테스트 코드를 실행하세요 (pytest 등).
    2. 테스트 실패 시 에러 로그를 Dev1에게 전달하여 수정을 요청하세요.
    3. 모든 테스트 통과 시 'TERMINATE'라고 말하세요."""
)

# 3. 그룹 채팅 구성
groupchat = autogen.GroupChat(
    agents=[planner, dev1, dev2, tester],
    messages=[],
    max_round=15
)

manager = autogen.GroupChatManager(groupchat=groupchat, llm_config=llm_config)

# 4. 실행
if __name__ == "__main__":
    task = """
    요청: 파일 암호화 및 복호화 유틸리티를 만들어줘.
    요구사항:
    - AES-256 알고리즘 사용
    - 유닛 테스트 포함 (pytest)
    - 에러 핸들링 (파일 없음, 키 불일치 등)
    """
    
    tester.initiate_chat(
        manager,
        message=task
    )
```

## 3. 핵심 운영 포인트

- **라우터의 역할**: 위 코드에서 `base_url`을 라우터로 지정했기 때문에, AutoGen이 메시지를 보낼 때마다 라우터가 `task_type`을 분석하여 `qwen3-coder-next` 또는 `qwen3-coder`로 지능적으로 분배합니다.
- **종료 조건**: Tester 에이전트가 모든 테스트 성공을 확인하고 `TERMINATE`를 출력하면 협업이 종료됩니다.
- **컨텍스트 유지**: `GroupChat`을 통해 모든 에이전트가 이전 대화 이력을 공유하므로, 설계 단계의 결정 사항이 구현과 검증까지 일관되게 이어집니다.
