# 05. ì¤‘ê³„ì ì—ì´ì „íŠ¸ ë¼ìš°íŒ… ë° ìµœì¢… ì •ë¦¬

M4 Pro 64GB í™˜ê²½ì—ì„œ ì‹œìŠ¤í…œ ë°˜ì‘ ì†ë„ì™€ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„ ê·¹ëŒ€í™”í•˜ê¸° ìœ„í•œ 'ì¤‘ê³„ì(Router)' ì—ì´ì „íŠ¸ì˜ í™œìš© ì „ëµê³¼ êµ¬í˜„ ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## 1. ì¤‘ê³„ì(Router)ì˜ í•µì‹¬ ì—­í• 

ì¤‘ê³„ìëŠ” ì´ˆê²½ëŸ‰ ëª¨ë¸(1.5b~3b)ì„ ì‚¬ìš©í•˜ì—¬ ì‹œìŠ¤í…œì˜ ì…êµ¬ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ 'ì§€ëŠ¥í˜• ê²Œì´íŠ¸ì›¨ì´' ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

1.  **ì—ì´ì „íŠ¸ ë¼ìš°íŒ… ë° ë©”ëª¨ë¦¬ íŠ¸ë¦¬ê±° (Traffic Control)**: ìš”ì²­ì´ ì‹ ê·œ ì„¤ê³„ì¸ì§€ ë‹¨ìˆœ ìˆ˜ì •ì¸ì§€ íŒë‹¨í•˜ì—¬ Architect í˜¸ì¶œ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
2.  **ì»¨í…ìŠ¤íŠ¸ ì••ì¶• ë° ìš”ì•½ (Context Management)**: ëŒ€í™” ê¸°ë¡ì„ ìš”ì•½í•˜ì—¬ ë‹¤ìŒ ì—ì´ì „íŠ¸ì—ê²Œ ì „ë‹¬í•¨ìœ¼ë¡œì¨ í† í° ë‚­ë¹„ë¥¼ ì¤„ì´ê³  ì¶”ë¡  ì†ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.
3.  **ê²°ê³¼ í¬ë§· ê²€ìˆ˜ (Sanity Check)**: ì—ì´ì „íŠ¸ì˜ ì¶œë ¥ì´ ê·œê²©(JSON ë“±)ì— ë§ëŠ”ì§€ ê²€ì‚¬í•˜ì—¬ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ì„ ë°©ì§€í•©ë‹ˆë‹¤.

## 2. ì¤‘ê³„ììš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë° ë¼ìš°íŒ… ë¡œì§

### 2.1 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (System Prompt)

ì¤‘ê³„ìì—ê²Œ ì—ì´ì „ì‹œ ìš´ì˜ì í˜ë¥´ì†Œë‚˜ë¥¼ ë¶€ì—¬í•˜ê³ , **2026ë…„ ìµœì‹  ê¸°ìˆ  ê¸°ì¤€ì˜ ë‚œì´ë„ íŒë‹¨ ë° 'ìê¸° ì„±ì°°' í™œì„±í™” ë¡œì§**ì„ íƒ‘ì¬í•˜ì—¬ íš¨ìœ¨ì„±ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤. (ìƒì„¸ ì „ëµì€ [14. ìê¸° ì„±ì°° ë° ì„±ëŠ¥ ìµœì í™” ì „ëµ](./14_ìê¸°_ì„±ì°°_ë°_ì„±ëŠ¥_ìµœì í™”_ì „ëµ.md) ì°¸ì¡°)

```text
ë„ˆëŠ” ë¡œì»¬ LLM ì—ì´ì „ì‹œì˜ ì´ê´„ ìš´ì˜ìë‹¤. ì‚¬ìš©ìì˜ ìš”ì²­ê³¼ 2026ë…„ ê¸°ì¤€ ì°¸ì¡° ë¬¸ì„œë¥¼ ë¶„ì„í•˜ì—¬ [ARCHITECT, CODER, TESTER, FRONTIER] ì¤‘ ëˆ„êµ¬ì—ê²Œ ë³´ë‚¼ì§€ ê²°ì •í•˜ë¼.

[ë¹„íŒì  ì‚¬ê³  ë° ì§€ì‹œì‚¬í•­]
1. [íƒìƒ‰ ë° ëŒ€ì¡°]: ì œê³µëœ 2026ë…„ ì‚¬ì–‘ì´ ê¸°ì¡´ ë°©ì‹ê³¼ ì¶©ëŒí•˜ëŠ”ì§€ í™•ì¸í•˜ë¼.
2. [ë‚œì´ë„ íŒì • ë° ì„±ì°° ë£¨í”„]:
   - [ë‚œì´ë„: ìƒ]: ì‹œìŠ¤í…œ ì „ë°˜ ì¬ì„¤ê³„, ë‹¤ì¤‘ íŒŒì¼ ì˜ì¡´ì„± ìˆ˜ì •. -> PLANNER í˜¸ì¶œ + Reviewer í•„ìˆ˜ ê²€í† (reflection: true).
   - [ë‚œì´ë„: ì¤‘]: ë³µì¡í•œ ë¡œì§, ë¬¸ì„œ 50% ì´ìƒ ì°¸ì¡° í•„ìš”. -> CODER í• ë‹¹ + Reviewer 1íšŒ ê²€í† (reflection: true).
   - [ë‚œì´ë„: í•˜]: ë‹¨ìˆœ ë¬¸ë²•/ë‹¨ì¼ íŒŒì¼ ìˆ˜ì •. -> CODER ì¦‰ì‹œ í• ë‹¹ (reflection: false, ì†ë„ ìš°ì„ ).
3. [ê²½ì œì  ìš´ì˜]: ì„±ëŠ¥ ì €í•˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë‚œì´ë„ 'í•˜' ì‘ì—…ì—ëŠ” ì„±ì°° ë£¨í”„ë¥¼ ëˆë‹¤.

ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ í•´:
{"difficulty": "ìƒ/ì¤‘/í•˜", "next_agent": "AGENT_NAME", "reason": "ë¶„ì„ ê²°ê³¼ ìš”ì•½", "requires_swap": true/false, "use_frontier": true/false, "activate_reflection": true/false}
```

### 2.2 íŒŒì´ì¬ ë¼ìš°íŒ… êµ¬í˜„ ì˜ˆì‹œ

```python
import ollama
import json
import os

def router_agent(user_input, agent_status="IDLE"):
    # 1. ì¤‘ê³„ì(1.5b) í˜¸ì¶œ - í•­ìƒ ë©”ëª¨ë¦¬ì— ìƒì£¼(keep_alive=-1)
    response = ollama.generate(
        model='qwen2.5:1.5b', 
        system="ìœ„ì˜ ìš´ì˜ 3ëŒ€ ì—„ê²© ê·œì¹™ í¬í•¨ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì…ë ¥",
        prompt=f"í˜„ì¬ ìƒíƒœ: {agent_status}\nìš”ì²­: {user_input}",
        format='json',
        keep_alive='-1' 
    )
    
    decision = json.loads(response['response'])
    next_step = decision['next_agent']
    
    # [ê·œì¹™ 1] Busy ìƒíƒœë©´ ëŒ€ê¸°
    if agent_status == "BUSY" and decision['requires_swap']:
        print("â³ ìƒì£¼ ëª¨ë¸ì´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤. ì™„ë£Œë  ë•Œê¹Œì§€ 52B ì†Œí™˜ì„ ëŒ€ê¸°í•©ë‹ˆë‹¤.")
        return "WAIT"

    # [ê·œì¹™ 3] 52B ì†Œí™˜ ì‹œ ìŠ¹ì¸ì œ
    if decision['requires_swap']:
        confirm = input(f"âš ï¸ {next_step} ì†Œí™˜ì„ ìœ„í•´ ìƒì£¼ ëª¨ë¸ì„ ì–¸ë§ˆìš´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
        if confirm.lower() != 'y':
            print("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œì»¬ ìƒì£¼ ëª¨ë¸ë¡œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.")
            return "CANCEL"
        
        # [ê·œì¹™ 2] ìŠ¤ëƒ…ìƒ· ì €ì¥
        save_snapshot(user_input)

    # í•˜ì´ë¸Œë¦¬ë“œ ì™¸ì£¼(Frontier) ì²˜ë¦¬
    if decision.get('use_frontier'):
        print("âš ï¸ ê³ ë‚œë„ ì‘ì—…ìœ¼ë¡œ íŒë‹¨ë˜ì–´ Frontier LLM(GPT-4o)ì— ìš”ì²­í•©ë‹ˆë‹¤.")
        return call_frontier_api(user_input)
```

### 2.3 ìŠ¤ëƒ…ìƒ· ì €ì¥ ë¡œì§ (Snapshot)

```python
def save_snapshot(context):
    """ëª¨ë¸ ìŠ¤ì™‘ ì „ í˜„ì¬ ë¬¸ë§¥ ì €ì¥"""
    snapshot = {
        "last_requirement": context,
        "working_files": ["app/main.py"], # ì˜ˆì‹œ
        "last_error": "None",
        "timestamp": "2026-02-10"
    }
    with open("shared/temp_context.json", "w") as f:
        json.dump(snapshot, f)
    print("ğŸ“¸ ì²´í¬í¬ì¸íŠ¸ê°€ shared/temp_context.jsonì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
```
        # Architect ë“± ë¬´ê±°ìš´ ëª¨ë¸ì„ ë¶€ë¥¼ ë•Œ ìƒì£¼ ëª¨ë¸(Coder, Reviewer) ì ì‹œ ë‚´ë¦¼
        print("ë¬´ê±°ìš´ ëª¨ë¸ ë¡œë“œë¥¼ ìœ„í•´ ê¸°ì¡´ ì—ì´ì „íŠ¸ ë©”ëª¨ë¦¬ ë°˜ë‚© ì¤‘...")
        run_architect(user_input)
    else:
        # ìƒì£¼í•´ ìˆëŠ” Coderë‚˜ Testerì—ê²Œ ë°”ë¡œ ì „ë‹¬
        if next_step == 'CODER':
            run_coder(user_input)
        elif next_step == 'TESTER':
            run_tester(user_input)
```

## 3. TDD ì‹¤íŒ¨ ë¡œê·¸ ë¶„ì„ ë° ìë™í™”

í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì¤‘ê³„ìê°€ ì—ëŸ¬ ë¡œê·¸ë¥¼ ë¶„ì„í•˜ì—¬ "ë‹¨ìˆœ ìˆ˜ì •"ì¸ì§€ "ì„¤ê³„ ë³€ê²½"ì¸ì§€ íŒë‹¨í•˜ì—¬ ë£¨í”„ë¥¼ ìë™í™”í•©ë‹ˆë‹¤.

### 3.1 ë¶„ì„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸

```text
ë„ˆëŠ” TDD ì›Œí¬í”Œë¡œìš°ì˜ ê´€ì œíƒ‘ì´ì•¼. í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë³´ê³  ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ê²°ì •í•´:

[ë¹„íŒì  ì‚¬ê³  ì§€ì¹¨]
- ì½”ë”ê°€ ì¸í„°ë„·ì—ì„œ ì°¸ì¡°í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìš©ë²•ì´ë‚˜ ë¡œì§ì´ ê³µì‹ ë¬¸ì„œì™€ ì¶©ëŒí•˜ì—¬ ë°œìƒí•œ ì—ëŸ¬ì¸ì§€ ìš°ì„  í™•ì¸í•˜ë¼.
- ê²€ìƒ‰ëœ í•´ê²°ì±…ì„ ë§¹ëª©ì ìœ¼ë¡œ ì ìš©í•˜ê¸°ë³´ë‹¤, í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì¡°ì™€ì˜ ì •í•©ì„±ì„ ë¨¼ì € ë”°ì ¸ë¼.
- [FIX_CODE]: ë‹¨ìˆœ ë…¼ë¦¬ ì˜¤ë¥˜ë‚˜ ë¬¸ë²• ì—ëŸ¬ì¼ ë•Œ (CODERì—ê²Œ ì „ë‹¬, swap: false)
- [RE_ARCHITECT]: í˜„ì¬ ì„¤ê³„ë¡œëŠ” í…ŒìŠ¤íŠ¸ í†µê³¼ê°€ ë¶ˆê°€ëŠ¥í•œ êµ¬ì¡°ì  ê²°í•¨ì¼ ë•Œ (ARCHITECTì—ê²Œ ì „ë‹¬, swap: true)
- [ENV_ERROR]: ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¯¸ì„¤ì¹˜ë‚˜ ê²½ë¡œ ë¬¸ì œ ë“± í™˜ê²½ ì˜¤ë¥˜ì¼ ë•Œ (USERì—ê²Œ ì¡°ì¹˜ ìš”ì²­)

ê²°ì • ì‚¬í•­:
1. [FIX_CODE]: ë‹¨ìˆœ ë…¼ë¦¬ ì˜¤ë¥˜ë‚˜ ë¬¸ë²• ì—ëŸ¬ì¼ ë•Œ
2. [RE_ARCHITECT]: í˜„ì¬ ì„¤ê³„ë¡œëŠ” í…ŒìŠ¤íŠ¸ í†µê³¼ê°€ ë¶ˆê°€ëŠ¥í•œ êµ¬ì¡°ì  ê²°í•¨ì¼ ë•Œ
3. [ENV_ERROR]: ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¯¸ì„¤ì¹˜ë‚˜ ê²½ë¡œ ë¬¸ì œ ë“± í™˜ê²½ ì˜¤ë¥˜ì¼ ë•Œ

ì‘ë‹µì€ ë°˜ë“œì‹œ JSON: {"action": "ACTION_NAME", "analysis": "ë¹„íŒì  ì—ëŸ¬ ë¶„ì„ ê²°ê³¼", "requires_swap": boolean}
```

### 3.2 ë¶„ì„ ë¡œì§ êµ¬í˜„

```python
def analyze_test_failure(test_log, code_context):
    """í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë¡œê·¸ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ê²°ì •í•˜ëŠ” í•¨ìˆ˜"""
    
    # ì¤‘ê³„ì(1.5b)ê°€ ì—ëŸ¬ ì›ì¸ íŒŒì•…
    response = ollama.generate(
        model='qwen2.5:1.5b',
        system="TDD ë¶„ì„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë‚´ìš©",
        prompt=f"[ë¡œê·¸]\n{test_log}\n[ì½”ë“œ]\n{code_context}",
        format='json',
        keep_alive='-1'
    )
    
    result = json.loads(response['response'])
    action = result['action']
    
    if action == "FIX_CODE":
        # ìƒì£¼ ì¤‘ì¸ Coderì—ê²Œ ì¦‰ì‹œ í”¼ë“œë°± (0ì´ˆ ì§€ì—°)
        return call_coder_for_fix(test_log, code_context)
    elif action == "RE_ARCHITECT":
        # ì„¤ê³„ ê²°í•¨ì´ë©´ Architect ë¡œë“œ (ë©”ëª¨ë¦¬ ìŠ¤ì™‘ ë°œìƒ)
        return call_architect_redesign(test_log, code_context)
```

## 4. ìµœì¢… ì •ë¦¬ ì—ì´ì „íŠ¸ (Documenter)

í˜‘ì—… ê²°ê³¼ë¬¼(ì„¤ê³„, ì½”ë“œ, í…ŒìŠ¤íŠ¸ ê²°ê³¼)ì„ ì·¨í•©í•˜ì—¬ ì‚¬ëŒì´ ì½ê¸° ì¢‹ì€ Markdown ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### 4.1 êµ¬í˜„ ë¡œì§

```python
def generate_final_report(plan, code, test_result):
    """ëª¨ë“  ì—ì´ì „íŠ¸ì˜ ê²°ê³¼ë¬¼ì„ ì·¨í•©í•´ MD ë¬¸ì„œ ìƒì„±"""
    
    context = f"[PLAN]\n{plan}\n[CODE]\n{code}\n[TEST]\n{test_result}"
    
    # ìƒì£¼ ì¤‘ì¸ Reviewer(14b) ë˜ëŠ” Router(1.5b) í™œìš©
    response = ollama.generate(
        model='qwen3-coder:14b', 
        system="ë„ˆëŠ” í”„ë¡œì íŠ¸ ê¸°ìˆ  ë¬¸ì„œí™” ì „ë¬¸ê°€ì•¼. ëª©ì°¨ì— ë§ê²Œ ë§ˆí¬ë‹¤ìš´ ë¬¸ì„œë¥¼ ì‘ì„±í•´.",
        prompt=f"ë°ì´í„° ë°”íƒ•ìœ¼ë¡œ ì™„ë£Œ ë³´ê³ ì„œ ì‘ì„±:\n{context}",
        keep_alive='2h'
    )
    
    with open("Project_Success_Report.md", "w", encoding="utf-8") as f:
        f.write(response['response'])
```

## 5. M4 Pro 64GB ìµœì í™” íŒ

1.  **ì§€ëŠ¥ì  ë©”ëª¨ë¦¬ ìŠ¤ì™‘**: 64GB í™˜ê²½ì—ì„œ 52GB ëª¨ë¸(Architect)ì€ ì„ê³„ì¹˜ì— ë„ë‹¬í•˜ë¯€ë¡œ, `keep_alive: 0`ì„ ì‚¬ìš©í•˜ì—¬ ì‘ì—… í›„ ì¦‰ì‹œ ë©”ëª¨ë¦¬ë¥¼ ë°˜ë‚©í•´ì•¼ í•©ë‹ˆë‹¤.
2.  **ì¤‘ê³„ì ìƒì£¼**: 1.5b ëª¨ë¸ì€ ë©”ëª¨ë¦¬ ì ìœ ê°€ ë¯¸ë¯¸í•˜ë¯€ë¡œ `keep_alive: -1`ë¡œ í•­ìƒ ë„ì›Œë‘ì–´ 0ì´ˆ ë°˜ì‘ ì†ë„ë¥¼ í™•ë³´í•©ë‹ˆë‹¤.
3.  **ë¹„ë™ê¸° ì²˜ë¦¬**: Local Executorê°€ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆ ì¤‘ê³„ìê°€ ë‹¤ìŒ ì‘ì—…ì„ ì¤€ë¹„í•˜ë„ë¡ `asyncio`ë¥¼ í™œìš©í•˜ë©´ ì „ì²´ ì‚¬ì´í´ ì†ë„ê°€ ë¹„ì•½ì ìœ¼ë¡œ í–¥ìƒë©ë‹ˆë‹¤.
