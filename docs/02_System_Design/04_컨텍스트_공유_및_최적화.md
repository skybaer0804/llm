# 04. 컨텍스트 공유 및 최적화

멀티 에이전트 시스템에서 에이전트 간의 문맥(Context)을 효율적으로 공유하고 토큰 사용을 최적화하는 방법을 다룹니다.

## 1. 에이전트 간 컨텍스트 공유의 원리

AutoGen 환경에서 설계자, 개발자, 검수자는 하나의 '그룹 채팅(Group Chat)' 또는 '순차적 대화(Sequential Chat)' 환경에서 정보를 주고받습니다.

- **설계 문서 공유**: 설계자가 생성한 아키텍처 가이드는 개발자와 검수자의 시스템 메시지에 주입되거나 대화 이력의 상단에 고정됩니다.
- **상태 전이**: 설계 → 코딩 → 검수 단계로 넘어갈 때, 이전 에이전트의 핵심 출력값이 다음 에이전트의 입력 컨텍스트로 전달됩니다.

## 2. 컨텍스트 최적화 전략

무제한적인 컨텍스트 공유는 모델의 추론 속도를 저하시키고 비용(토큰)을 낭비합니다.

### ① 증분 정보 전달 (Incremental Updates)
- 코드 전체를 매번 다시 보내는 대신, 수정된 함수나 클래스 단위의 **Diff** 정보를 전달합니다.
- `qwen3-coder` 모델은 이러한 부분적 변경 사항을 이해하는 능력이 탁월합니다.

### ② 요약 및 압축 (Summarization)
- 대화가 길어질 경우, 설계자 에이전트(Planner)가 중간에 대화 내용을 요약하여 컨텍스트 창을 비웁니다.
- 핵심 결정 사항과 TODO 리스트만 남기고 상세 로그는 제거합니다.

### ③ 외부 지식 저장소 (RAG) 활용
- 대규모 코드베이스의 경우 모든 소스를 컨텍스트에 넣는 대신, 관련 있는 파일만 검색하여 에이전트에게 제공합니다.

### ④ 언어별 토큰 효율 고려
- 영어, 한국어, 한자의 토큰 소모량이 다르므로, 상황에 맞는 언어 선택으로 컨텍스트를 절약합니다. 상세 내용은 [06. Qwen3 토큰 사용량 및 효율성 가이드](./06_Qwen3_토큰_사용량_및_효율성.md)를 참고하세요.

## 3. Qwen3-Coder-Next의 특장점 활용

`qwen3-coder-next`는 **256K 토큰**의 광활한 컨텍스트 창을 지원합니다.
- **장기 기억 유지**: 프로젝트 초기의 설계 의도를 잊지 않고 마지막 검증 단계까지 유지할 수 있습니다.
- **대형 파일 분석**: 수천 줄의 소스 코드와 기술 문서를 한 번에 입력받아 분석할 수 있어, 컨텍스트 분절로 인한 오류를 방지합니다.

## 4. 분산 환경에서의 컨텍스트 공유 (Thunderbolt Synchronization)

맥북과 맥미니로 분리된 분산 환경에서는 네트워크를 통한 빠른 데이터 동기화가 필수적입니다.

- **FastAPI 기반 데이터 전송**: 라우터(`router.py`)가 맥북에서 수집한 컨텍스트(사용자 요청, 스냅샷)를 JSON 형태로 맥미니의 워커 모델에게 전송합니다.
- **Shared Folder 마운트**: 썬더볼트 브리지를 통해 맥미니의 프로젝트 폴더를 맥북에 마운트하여, 양쪽 기기의 에이전트가 동일한 파일 시스템(Git 레포지토리)을 바라보게 설정합니다.
- **Snapshot 공유**: 모델 스왑이나 기기 간 작업 전환 시 `shared/temp_context.json` 파일을 사용하여 현재까지의 진행 상황을 0.1초 내외의 속도로 공유합니다.

## 5. 실제 적용 가이드

- **System Message 최적화**: 각 에이전트의 역할과 현재 단계의 목표를 시스템 메시지에 명확히 명시하여 불필요한 질문을 줄입니다.
- **Structured Output (JSON)**: 에이전트 간 통신에 JSON 포맷을 사용하여 정보 누락 없이 정확한 데이터를 전달합니다.
