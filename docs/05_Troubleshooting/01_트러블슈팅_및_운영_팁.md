# 01. 트러블슈팅 및 운영 팁

로컬 LLM 및 AutoGen 시스템 운영 중 발생할 수 있는 주요 문제들과 해결 방안, 그리고 성능 최적화 팁을 정리합니다.

## 1. 메모리(RAM) 관련 트러블슈팅

M4 Pro 64GB 환경에서 가장 흔히 발생하는 문제는 GPU 가용 메모리 제한으로 인한 OOM(Out of Memory) 에러입니다.

### ⚠️ 증상: "Memory insufficient" 또는 모델 로드 중단
macOS는 기본적으로 전체 RAM의 약 70% 정도만 GPU가 점유하도록 제한합니다.

### ✅ 해결 방안 1: GPU 메모리 한도 강제 상향
터미널에서 아래 명령어를 실행하여 GPU 가용 범위를 약 90%(56GB)까지 높일 수 있습니다.
```bash
sudo sysctl iogpu.wired_limit_mb=57344
```
*참고: 이 설정은 재부팅 시 초기화되므로 실행 스크립트에 포함하는 것이 좋습니다.*

### ✅ 해결 방안 2: 컨텍스트 길이(`num_ctx`) 제한
모델의 컨텍스트 창이 커질수록 필요한 VRAM이 기하급수적으로 늘어납니다. 대형 모델의 경우 8k(8192) 또는 16k 정도로 제한하면 수 GB의 메모리를 절약할 수 있습니다.
```bash
# Ollama 실행 시 파라미터 지정
ollama run qwen3-coder-next:q4_K_M --set parameter num_ctx 8192
```

## 2. 서비스 연결 및 실행 에러

### Ollama 서비스 응답 없음
- **체크**: `curl http://localhost:11434` 명령으로 응답 확인.
- **해결**: `brew services restart ollama`로 서비스 재시작.

### 라우터(router.py) 접속 불가
- **체크**: `lsof -i :8000`으로 포트 점유 확인.
- **해결**: 기존 프로세스 종료 후 재실행, 로그(`tail -f /tmp/router.log`) 확인.

### Docker (OpenWebUI) 시작 실패
- **해결**: `docker restart open-webui` 실행. 디스크 공간이 부족할 경우 `docker system prune`으로 공간 확보.

## 3. AutoGen 운영 팁

- **무한 루프 방지**: 에이전트 간 대화가 끝나지 않을 경우 `max_round`를 10~15회로 제한하거나, `UserProxyAgent`의 `human_input_mode`를 적절히 활용하세요.
- **TDD 실패 반복**: 개발 에이전트가 동일한 에러를 3회 이상 고치지 못한다면, 모델 체급을 높이거나(Architect 개입 요청) 사람이 직접 가이드를 주어야 합니다.
- **토큰 소모 관리**: 대화 이력이 너무 길어지면 요약(Summary) 기능을 사용하여 컨텍스트를 압축하세요.

## 4. Qwen 모델 한자(Hanja) 출력 문제 해결

Qwen 모델은 중국 Alibaba에서 개발되어 기본 학습 데이터에 한자가 많이 포함되어 있습니다. 이로 인해 한국어 답변 중 한자가 섞여 나오는 현상이 발생할 수 있습니다.

### ✅ 해결 방안 1: 시스템 프롬프트 수정
Open WebUI의 어드민 패널에서 모델 설정을 수정하여 한자 사용을 엄격히 금지합니다.
1.  `Admin Panel` > `Models` 클릭.
2.  사용 중인 Qwen 모델 옆의 연필 아이콘(수정) 클릭.
3.  `System Prompt` 칸에 아래 문장을 추가:
    > "You are a helpful assistant. You must communicate in Korean or English only. Never use Chinese characters (Hanja)."
4.  하단의 **저장(Save)** 클릭.

### ✅ 해결 방안 2: RAG 템플릿 강화
RAG 사용 시에도 한자가 튀어나온다면 RAG 템플릿에 **"한자 절대 금지"** 지침을 명시해야 합니다. 상세 내용은 **[Open WebUI RAG 가이드](../03_AutoGen_Agents/04-1_OpenWebUI_RAG_및_지식_자산화.md#4-qwen-전용-최적화-rag-템플릿)**를 참고하세요.

### ✅ 해결 방안 3: 모델 교체 권장 (맥 미니 최적화)
한자 문제가 지속적으로 발생하거나 스트레스라면, 한국어/서구권 데이터 비중이 높은 아래 모델들로 교체하는 것을 추천합니다.
- **Llama-3-Open-Ko 계열**: 한국어 특화 튜닝이 잘 되어 있어 한자 혼용이 거의 없습니다.
- **Gemma-2-9b-it**: 구글의 모델로 한국어 성능이 준수하며 한자 문제가 적습니다.

## 5. 하드웨어 관리 팁

- **발열 관리**: M4 Pro는 성능이 높지만 지속적인 추론 시 발열이 발생할 수 있습니다. 맥미니 하단 및 주변 통풍 공간을 확보하세요.
- **전원 안정성**: 24시간 운영 시 정전에 대비하여 **UPS(무정전 전원 장치)** 사용을 강력 권장합니다.
